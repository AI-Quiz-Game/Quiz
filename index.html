<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Quiz Game (Futuristic)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* Base Styles */
html, body {
height: 100%;
width: 100%;
margin: 0;
padding: 0;
overflow: hidden;
font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif;
color: #e2e8f0;
}

/* Futuristic Animated Background */
body {
display: flex;
justify-content: center;
align-items: center;
background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
background-size: 400% 400%;
animation: gradient-animation 15s ease infinite;
}

@keyframes gradient-animation {
0% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
100% { background-position: 0% 50%; }
}

/* Glassmorphism Effect for Containers */
.futuristic-card {
background-color: rgba(255, 255, 255, 0.1);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.2);
box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
border-radius: 1.5rem;
max-height: 95%;
overflow-y: auto;
}

/* Button Animations */
.btn-futuristic {
transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
transform: perspective(1px) translateZ(0);
box-shadow: 0 0 1px rgba(0, 0, 0, 0);
}
.btn-futuristic:hover {
transform: scale(1.05);
box-shadow: 0 10px 20px rgba(0,0,0,0.25), 0 6px 6px rgba(0,0,0,0.22);
}

.option-btn.correct {
background-color: #22c55e !important;
border-color: #16a34a !important;
color: white !important;
animation: pulse-correct 1s infinite;
}
.option-btn.incorrect {
background-color: #ef4444 !important;
border-color: #dc2626 !important;
color: white !important;
}
.option-btn:disabled {
cursor: not-allowed;
opacity: 0.7;
}

/* Pulsing effect for correct answer */
@keyframes pulse-correct {
0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
}

/* Progress Bar Styling */
#progress-bar-container {
width: 100%;
height: 8px;
background-color: rgba(255, 255, 255, 0.2);
border-radius: 9999px;
overflow: hidden;
margin-top: 1rem;
}
#progress-bar {
height: 100%;
width: 0%;
background: linear-gradient(to right, #6d28d9, #c026d3);
transition: width 0.4s ease-in-out;
border-radius: 9999px;
}

/* General Layout */
#game-wrapper {
width: 100vw;
height: 100vh;
display: flex;
justify-content: center;
align-items: center;
padding: 1rem;
box-sizing: border-box;
}

#app-container {
width: 100%;
max-width: 450px;
aspect-ratio: 9 / 16;
background-color: rgba(0, 0, 0, 0.2);
border-radius: 1.5rem;
padding: 1.5rem;
display: flex;
flex-direction: column;
justify-content: center;
}

/* Responsive Font Sizing */
@media (max-width: 640px) {
#main-title, #menu-title { font-size: 2rem; }
#main-subtitle, #final-score-text, #final-time-text, #loader-text { font-size: 1rem; }
.text-lg { font-size: 1rem; }
.text-xl { font-size: 1.125rem; }
}

</style>
</head>
<body class="bg-gray-900 text-white">
<div id="game-wrapper">
<div id="app-container">

<div id="menu-button-container" class="fixed top-4 left-4 z-50">
<button id="menu-toggle-btn" class="p-3 rounded-full bg-indigo-700 hover:bg-indigo-600 text-white shadow-lg focus:outline-none btn-futuristic">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
</button>
</div>

<div id="side-menu" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
<div class="p-6 text-right">
<button id="close-menu-btn" class="text-white text-3xl font-bold focus:outline-none">&times;</button>
</div>
<div class="p-6">
<h2 id="menu-title" class="text-3xl font-bold text-indigo-400 mb-6 text-center"></h2>
<ul class="space-y-4 text-center">
<li><button id="menu-home-btn" class="text-xl text-white hover:text-indigo-300 focus:outline-none font-bold underline"></button></li>
<li><button id="menu-description-btn" class="text-xl text-white hover:text-indigo-300 focus:outline-none font-bold underline"></button></li>
<li><button id="menu-help-btn" class="text-xl text-white hover:text-indigo-300 focus:outline-none font-bold underline"></button></li>
</ul>
<div id="menu-content" class="mt-8 p-4 bg-white bg-opacity-10 rounded-lg max-w-lg mx-auto futuristic-card">
<h3 id="menu-content-title" class="text-2xl font-semibold text-purple-300 mb-4 text-center"></h3>
<div id="menu-content-text" class="text-gray-200 leading-relaxed"></div>
</div>
</div>
</div>

<div id="language-selection-screen" class="p-8 futuristic-card text-center">
<h1 class="text-4xl md:text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-500">Welcome!</h1>
<p class="text-gray-300 mb-8 text-base">Please select your language / कृपया अपनी भाषा चुनें</p>
<p id="ai-mistakes-text" class="text-yellow-400 text-sm mb-4 hidden">AI can make mistakes.</p>
<div class="flex flex-col sm:flex-row gap-4 justify-center">
<button id="lang-en-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg btn-futuristic shadow-lg">English</button>
<button id="lang-hi-btn" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-lg btn-futuristic shadow-lg">हिन्दी</button>
</div>
</div>

<div id="start-screen" class="hidden p-8 futuristic-card">
<h1 id="main-title" class="text-3xl md:text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-500"></h1>
<p id="main-subtitle" class="text-gray-300 text-base md:text-lg mb-6"></p>

<div class="space-y-4 mb-6">
<input type="text" id="topic-input" class="w-full bg-white bg-opacity-10 text-white placeholder-gray-400 border-2 border-transparent rounded-lg py-3 px-4 text-center focus:outline-none focus:border-indigo-500 transition-colors" aria-label="Enter quiz topic">
<input type="number" id="questions-count-input" class="w-full bg-white bg-opacity-10 text-white placeholder-gray-400 border-2 border-transparent rounded-lg py-3 px-4 text-center focus:outline-none focus:border-indigo-500 transition-colors" min="1" max="500" aria-label="Number of questions">
<label for="difficulty-input" id="difficulty-label" class="block text-gray-300 text-sm font-bold mb-2 sr-only"></label>
<select id="difficulty-input" class="w-full bg-white bg-opacity-10 text-white border-2 border-transparent rounded-lg py-3 px-4 text-center focus:outline-none focus:border-indigo-500 transition-colors" aria-labelledby="difficulty-label">
<option value="easy">Easy / आसान</option>
<option value="medium">Medium / मध्यम</option>
<option value="hard">Hard / कठिन</option>
</select>
</div>

<button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg md:text-xl btn-futuristic shadow-lg mb-6"></button>

<div id="history-container" class="mt-6 text-left">
<h3 id="history-title" class="text-base font-semibold text-indigo-300 mb-2"></h3>
<ul id="topic-history" class="max-h-32 overflow-y-auto bg-white bg-opacity-10 rounded-lg p-2 text-sm">
</ul>
</div>
</div>

<div id="quiz-screen" class="hidden p-6 futuristic-card">
<div class="flex justify-between items-center mb-4">
<p id="progress-text" class="text-base md:text-lg text-gray-300"></p>
<p id="total-timer-display" class="text-lg font-bold text-yellow-400"></p>
<p id="score-display" class="text-base md:text-lg font-bold text-indigo-400"></p>
</div>
<div id="progress-bar-container"><div id="progress-bar"></div></div>
<div id="question-container" class="bg-white bg-opacity-10 p-4 rounded-lg mt-4 mb-4 min-h-[80px] flex items-center justify-center">
<p id="question-text" class="text-lg md:text-xl text-center font-semibold"></p>
</div>
<div id="options-container" class="grid grid-cols-1 gap-3"></div>
<div id="explanation-container" class="hidden mt-4 p-3 bg-white bg-opacity-10 rounded-lg text-sm">
<h4 id="explanation-title" class="font-bold text-purple-300 mb-1"></h4>
<p id="explanation-text" class="text-gray-200"></p>
</div>
<div id="navigation-container" class="flex justify-between mt-4">
<button id="prev-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg btn-futuristic text-sm"></button>
<button id="home-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg btn-futuristic text-sm"></button>
<button id="next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg btn-futuristic text-sm"></button>
</div>
</div>

<div id="results-screen" class="hidden text-center p-8 futuristic-card">
<h2 id="results-title" class="text-2xl font-bold mb-4 text-indigo-400"></h2>
<p id="final-score-text" class="text-xl mb-4"></p>
<p id="final-time-text" class="text-xl mb-6"></p>
<div class="flex flex-col gap-4">
<button id="play-again-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg btn-futuristic shadow-lg"></button>
<button id="share-score-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg btn-futuristic shadow-lg mt-2"></button>
<button id="whatsapp-channel-btn-results" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg text-lg btn-futuristic shadow-lg mt-4 whatsapp-half-glow-btn">
Join Our WhatsApp Channel
</button>
<button id="home-btn-results" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg btn-futuristic shadow-lg"></button>
</div>
</div>

<div id="loader" class="hidden text-center p-8">
<div class="flex justify-center items-center">
<div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-400"></div>
</div>
<p id="loader-text" class="mt-4 text-base"></p>
</div>

<div id="message-box" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg animate-pulse z-50">
<p id="message-text"></p>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
const langScreen = document.getElementById('language-selection-screen');
const startScreen = document.getElementById('start-screen');
const quizScreen = document.getElementById('quiz-screen');
const resultsScreen = document.getElementById('results-screen');
const loader = document.getElementById('loader');
const aiMistakesText = document.getElementById('ai-mistakes-text');

const langEnBtn = document.getElementById('lang-en-btn');
const langHiBtn = document.getElementById('lang-hi-btn');
const startBtn = document.getElementById('start-btn');
const playAgainBtn = document.getElementById('play-again-btn');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const homeBtn = document.getElementById('home-btn');
const homeBtnResults = document.getElementById('home-btn-results');
const shareScoreBtn = document.getElementById('share-score-btn');
const whatsappChannelBtnResults = document.getElementById('whatsapp-channel-btn-results');

const menuToggleBtn = document.getElementById('menu-toggle-btn');
const sideMenu = document.getElementById('side-menu');
const closeMenuBtn = document.getElementById('close-menu-btn');
const menuTitle = document.getElementById('menu-title');
const menuHomeBtn = document.getElementById('menu-home-btn');
const menuDescriptionBtn = document.getElementById('menu-description-btn');
const menuHelpBtn = document.getElementById('menu-help-btn');
const menuContent = document.getElementById('menu-content');
const menuContentTitle = document.getElementById('menu-content-title');
const menuContentText = document.getElementById('menu-content-text');

const topicInput = document.getElementById('topic-input');
const questionsCountInput = document.getElementById('questions-count-input');
const difficultyInput = document.getElementById('difficulty-input');
const difficultyLabel = document.getElementById('difficulty-label');
const questionText = document.getElementById('question-text');
const optionsContainer = document.getElementById('options-container');
const explanationContainer = document.getElementById('explanation-container');
const explanationText = document.getElementById('explanation-text');
const progressText = document.getElementById('progress-text');
const scoreDisplay = document.getElementById('score-display');
const totalTimerDisplay = document.getElementById('total-timer-display');
const finalScoreText = document.getElementById('final-score-text');
const finalTimeText = document.getElementById('final-time-text');
const historyContainer = document.getElementById('history-container');
const topicHistoryList = document.getElementById('topic-history');
const messageBox = document.getElementById('message-box');
const messageText = document.getElementById('message-text');
const progressBar = document.getElementById('progress-bar');

let questions = [];
let userAnswers = [];
let currentQuestionIndex = 0;
let score = 0;
let currentLanguage = 'en';
let currentTopic = '';
let totalTimer = null;
let startTime = 0;
let elapsedTime = 0;

const gameLink = '';

const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playSound(frequency, type, duration = 0.1) {
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();

oscillator.type = type;
oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);

oscillator.start();
oscillator.stop(audioContext.currentTime + duration);
}

const uiStrings = {
'en': {
mainTitle: 'AI-Powered Quiz Game',
mainSubtitle: 'Test your knowledge on any topic!',
topicPlaceholder: 'Enter any topic (e.g., History of India)',
questionsCountPlaceholder: 'Number of questions (e.g.20)',
difficultyLabel: 'Select Difficulty',
startBtn: 'Start Quiz',
historyTitle: 'Recent Topics:',
score: 'Score',
questionProgress: 'Question',
timerText: 'Time',
explanationTitle: 'Explanation:',
prevBtn: 'Previous',
nextBtn: 'Next',
finishBtn: 'Finish',
homeBtn: 'Back to Home',
resultsTitle: 'Quiz Complete!',
finalScore: 'Your final score is:',
finalTime: 'Time taken to complete:',
playAgainBtn: 'Play Again',
shareScoreBtn: 'Share Score',
whatsappChannelBtn: 'Join Our WhatsApp Channel',
loaderText: 'AI is generating your Quiz, wait for a few minutes',
errorTopic: 'Please enter a topic.',
errorQuestionCount: 'Please choose between 1 and 200 questions.',
errorAPIFail: 'Failed to generate questions. Please try again.',
apiCountWarning: (count) => `The AI could only generate ${count} questions.`,
invalidJson: 'Received invalid data from AI. Please try again.',

menuTitle: 'Menu',
menuHome: 'Home',
menuDescription: 'Description',
menuHelp: 'Help',
descriptionTitle: 'About This Game',
descriptionText: `
<p>Welcome to the AI-Powered Quiz Game! This unique game allows you to test your knowledge on virtually any topic you can imagine like Science, History, Geography, Political Science, Indian Constitution, NCERT books, etc.</p>
<p>Simply enter a topic, choose the number of questions and difficulty level, and our advanced AI will generate a custom quiz just for you.</p>
<p>Challenge yourself, learn new facts, and have fun!</p>
`,
helpTitle: 'How to Play',
helpText: `
<p>1. <b>Select Language:</b> Choose your preferred language (English or Hindi) on the first screen.</p>
<p>2. <b>Enter Topic:</b> On the start screen, type any topic you want to be quizzed on (e.g., "Indian History", "Science", "Movies").</p>
<p>3. <b>Set Questions & Difficulty:</b> Enter the number of questions you want (1-200) and select the difficulty level (Easy, Medium, Hard).</p>
<p>4. <b>Start Quiz:</b> Click 'Start Quiz' to begin. The AI will generate questions, which may take a few moments.</p>
<p>5. <b>Answer Questions:</b> For each question, select one of the four options.</p>
<p>6. <b>Review & Navigate:</b> After answering, the correct answer and an explanation will be shown.
Use 'Previous' and 'Next' buttons to navigate. 'Next' becomes 'Finish' on the last question.</p>
<p>7. <b>View Results:</b> After the last question, your final score and the total time taken will be displayed.
You can play again or go back to the home screen.</p>
<p>8. <b>Share Score:</b> Share your quiz results with friends!</p>
<p>9. <b>Use it like an app :</b>You can use it like an app.
Just open it in the Chrome browser, click on the three dots at the top of the browser, and select "Add to Home screen".
Doing this will place the application on your device’s Home screen, and you can use it just like an app !</p>
`,
shareMessage: (quizTitle, score, total, topic, link) => `💡 ${quizTitle}\n\n🗒 Topic: ${topic}\n✅️ Score: ${score}/${total}\n\n😅 Can you beat my Score?\n\n⭐️ Play here, and test your knowledge on any topic 👇\n${link}`
},
'hi': {
mainTitle: 'AI-Powered Quiz Game',
mainSubtitle: 'किसी भी विषय पर अपनी ज्ञान की परीक्षा करें!',
topicPlaceholder: 'कोई विषय दर्ज करें (जैसे:विज्ञान)',
questionsCountPlaceholder: 'प्रश्नों की संख्या (जैसे:20)',
difficultyLabel: 'कठिनाई स्तर चुनें',
startBtn: 'क्विज़ शुरू करें',
historyTitle: 'पिछला इतिहास:',
score: 'स्कोर',
questionProgress: 'प्रश्न',
timerText: 'समय',
explanationTitle: 'स्पष्टीकरण:',
prevBtn: 'पिछला',
nextBtn: 'अगला',
finishBtn: 'समाप्त',
homeBtn: 'होम पर वापस',
resultsTitle: 'क्विज़ समाप्त!',
finalScore: 'आपका अंतिम स्कोर है:',
finalTime: 'क्विज़ पूरा करने में लगा समय:',
playAgainBtn: 'फिर से खेलें',
shareScoreBtn: 'स्कोर साझा करें',
whatsappChannelBtn: 'हमारे WhatsApp चैनल से जुड़ें',
loaderText: 'AI आपके लिए क्विज़ बना रहा है, कृपया कुछ मिनट प्रतीक्षा करें',
errorTopic: 'कृपया एक विषय दर्ज करें।',
errorQuestionCount: 'कृपया 1 और 200 के बीच प्रश्नों की संख्या चुनें।',
errorAPIFail: 'प्रश्न बनाने में विफल। कृपया पुनः प्रयास करें।',
apiCountWarning: (count) => `AI केवल ${count} प्रश्न ही बना सका।`,
invalidJson: 'AI से अमान्य डेटा प्राप्त हुआ। कृपया पुनः प्रयास करें।',

menuTitle: 'मेनू',
menuHome: 'होम',
menuDescription: 'विवरण',
menuHelp: 'सहायता',
descriptionTitle: 'इस गेम के बारे में',
descriptionText: `
<p>AI-संचालित क्विज़ गेम में आपका स्वागत है! यह अनोखा गेम आपको विज्ञान, इतिहास, भूगोल, राजनीति विज्ञान, भारतीय संविधान, NCERT की किताबें आदि जैसे लगभग किसी भी विषय पर अपने ज्ञान का परीक्षण करने की सुविधा देता है।</p>
<p>बस एक विषय दर्ज करें, प्रश्नों की संख्या और कठिनाई स्तर चुनें, और हमारा उन्नत AI आपके लिए एक विशेष क्विज़ तैयार कर देगा।</p>
<p>खुद को चुनौती दें, नए तथ्य सीखें और मज़े करें!</p>
`,
helpTitle: 'कैसे खेलें',
helpText: `
<p>1. <b>भाषा चुनें:</b> पहली स्क्रीन पर अपनी पसंदीदा भाषा (अंग्रेजी या हिंदी) चुनें।</p>
<p>2. <b>विषय दर्ज करें:</b> स्टार्ट स्क्रीन पर, आप जिस भी विषय पर क्विज़ खेलना चाहते हैं उसे टाइप करें (जैसे, "भारतीय इतिहास", "विज्ञान", "फिल्में")।</p>
<p>3. <b>प्रश्नों की संख्या और कठिनाई सेट करें:</b> आप जितने प्रश्न चाहते हैं (1-200) दर्ज करें और कठिनाई स्तर (आसान, मध्यम, कठिन) चुनें।</p>
<p>4. <b>क्विज़ शुरू करें:</b> क्विज़ शुरू करें पर क्लिक करें। AI प्रश्न तैयार करेगा, जिसमें कुछ क्षण लग सकते हैं।</p>
<p>5. <b>प्रश्नों का उत्तर दें:</b> प्रत्येक प्रश्न के लिए, चार विकल्पों में से एक चुनें।</p>
<p>6. <b>समीक्षा करें और नेविगेट करें:</b> उत्तर देने के बाद, सही उत्तर और एक स्पष्टीकरण दिखाया जाएगा।
यूज 'पिछला' और 'अगला' बटन का उपयोग करें। अंतिम प्रश्न पर 'अगला' बटन 'समाप्त' में बदल जाएगा।</p>
<p>7. <b>परिणाम देखें:</b> अंतिम प्रश्न के बाद, आपका अंतिम स्कोर और क्विज़ पूरा करने में लगा कुल समय प्रदर्शित होगा।
आप फिर से खेल सकते हैं या होम स्क्रीन पर वापस जा सकते हैं।</p>
<p>8. <b>स्कोर साझा करें:</b> अपने क्विज़ परिणामों को दोस्तों के साथ साझा करें!</p>
<p>9. <b>App की तरह इस्तेमाल करें:</b>आप इसे ऐप की तरह इस्तेमाल कर सकते हैं।
बस इसे क्रोम ब्राउज़र में खोलें, ब्राउज़र में सबसे ऊपर दिए गए तीन बिंदुओं पर क्लिक करें और "होम स्क्रीन में जोड़ें" चुनें।
ऐसा करने से यह ऐप्लिकेशन आपके डिवाइस की होम स्क्रीन पर आ जाएगा और आप इसे ऐप की तरह इस्तेमाल कर सकते हैं!</p>
 
`,
shareMessage: (quizTitle, score, total, topic, link) => `💡 ${quizTitle}\n\n🗒 विषय: ${topic}\n✅️ स्कोर: ${score}/${total}\n\n😅 क्या आप मेरा स्कोर हरा सकते हैं?\n\n⭐️ यहां खेलें, और अपने ज्ञान की परीक्षा करें 👇\n${link}`
}
};

function updateUIText() {
const t = uiStrings[currentLanguage];
document.title = t.mainTitle;
document.getElementById('main-title').textContent = t.mainTitle;
document.getElementById('main-subtitle').textContent = t.mainSubtitle;
topicInput.placeholder = t.topicPlaceholder;
questionsCountInput.placeholder = t.questionsCountPlaceholder;
difficultyLabel.textContent = t.difficultyLabel;
startBtn.textContent = t.startBtn;
document.getElementById('history-title').textContent = t.historyTitle;
document.getElementById('explanation-title').textContent = t.explanationTitle;
prevBtn.textContent = t.prevBtn;
nextBtn.textContent = t.nextBtn;
homeBtn.textContent = t.homeBtn;
homeBtnResults.textContent = t.homeBtn;
document.getElementById('results-title').textContent = t.resultsTitle;
playAgainBtn.textContent = t.playAgainBtn;
shareScoreBtn.textContent = t.shareScoreBtn;
whatsappChannelBtnResults.textContent = t.whatsappChannelBtn;

menuTitle.textContent = t.menuTitle;
menuHomeBtn.textContent = t.menuHome;
menuDescriptionBtn.textContent = t.menuDescription;
menuHelpBtn.textContent = t.menuHelp;
updateMenuContent(menuContentText.dataset.activeSection || 'description');
}

function shuffleArray(array) {
for (let i = array.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[array[i], array[j]] = [array[j], array[i]];
}
}

function startTotalTimer() {
startTime = Date.now();
totalTimer = setInterval(() => {
const now = Date.now();
elapsedTime = Math.floor((now - startTime) / 1000);
totalTimerDisplay.textContent = `${uiStrings[currentLanguage].timerText}: ${elapsedTime}s`;
}, 1000);
}

function clearTotalTimer() {
if (totalTimer) {
clearInterval(totalTimer);
totalTimer = null;
}
}

function setLanguage(lang) {
currentLanguage = lang;
document.documentElement.lang = lang;
updateUIText();
langScreen.classList.add('hidden');
startScreen.classList.remove('hidden');
loadTopicHistory();
aiMistakesText.classList.remove('hidden');
}

function showMessage(message) {
messageText.textContent = message;
messageBox.classList.remove('hidden');
setTimeout(() => messageBox.classList.add('hidden'), 3000);
}

async function startGame() {
const topic = topicInput.value.trim();
const questionCount = parseInt(questionsCountInput.value);
const difficulty = difficultyInput.value;
currentTopic = topic;

if (!topic) {
showMessage(uiStrings[currentLanguage].errorTopic);
return;
}
if (isNaN(questionCount) || questionCount < 1 || questionCount > 500) {
showMessage(uiStrings[currentLanguage].errorQuestionCount);
return;
}

startScreen.classList.add('hidden');
loader.classList.remove('hidden');
document.getElementById('loader-text').textContent = uiStrings[currentLanguage].loaderText;

try {
await fetchQuizData(topic, questionCount, difficulty);
saveTopicHistory(topic);

loader.classList.add('hidden');
quizScreen.classList.remove('hidden');

currentQuestionIndex = 0;
score = 0;
userAnswers = new Array(questions.length).fill(null);
scoreDisplay.textContent = `${uiStrings[currentLanguage].score}: 0`;
startTotalTimer();

displayQuestion();
} catch (error) {
console.error('क्विज़ जनरेशन या एपीआई कॉल के दौरान त्रुटि:', error);
showMessage(error.message || uiStrings[currentLanguage].errorAPIFail);
loader.classList.add('hidden');
startScreen.classList.remove('hidden');
}
}

async function fetchQuizData(topic, count, difficulty, retries = 3, delay = 1000) {
const langInstruction = currentLanguage === 'hi'
? `सभी टेक्स्ट (प्रश्न, विकल्प, उत्तर, स्पष्टीकरण) केवल हिंदी में होने चाहिए।`
: `All text (question, options, answer, explanation) must be in English.`;
const difficultyInstruction = `Questions should be of ${difficulty} difficulty level.`;

const prompt = `Create a multiple-choice quiz on the topic "${topic}". It should have ${count} questions.
Provide output in JSON format. The JSON should be an array of objects.
Each object must have four keys: 'question' (string), 'options' (an array of 4 strings), 'answer' (the correct answer string), and 'explanation' (a brief explanation of the correct answer).
${langInstruction} ${difficultyInstruction} Return only the JSON object, no other text.`;

const payload = {
contents: [{ role: "user", parts: [{ text: prompt }] }],
generationConfig: {
responseMimeType: "application/json",
responseSchema: {
type: "ARRAY",
items: {
type: "OBJECT",
properties: {
"question": { "type": "STRING" },
"options": { "type": "ARRAY", "items": { "type": "STRING" } },
"answer": { "type": "STRING" },
"explanation": { "type": "STRING" }
},
required: ["question", "options", "answer", "explanation"]
}
}
}
};

const apiKey = "AIzaSyBLw7RbzlVYQyDEiTnCpv0lby878ds2nqY";
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

for (let i = 0; i < retries; i++) {
try {
const response = await fetch(apiUrl, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});

if (!response.ok) {
if (response.status >= 500 || response.status === 429) {
if (i < retries - 1) {
await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
continue;
}
}
throw new Error(`API Error: ${response.status} ${response.statusText}`);
}

const result = await response.json();

if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
try {
const jsonText = result.candidates[0].content.parts[0].text;
questions = JSON.parse(jsonText);
if (!Array.isArray(questions) || questions.length === 0) {
throw new Error(uiStrings[currentLanguage].invalidJson);
}
shuffleArray(questions);

if (questions.length < count) {
showMessage(uiStrings[currentLanguage].apiCountWarning(questions.length));
}
return;
} catch (parseError) {
console.error('JSON पार्सिंग त्रुटि:', parseError);
throw new Error(uiStrings[currentLanguage].invalidJson);
}
} else {
throw new Error(uiStrings[currentLanguage].errorAPIFail);
}
} catch (error) {
if (i === retries - 1) {
throw error;
}
console.warn(`प्रयास ${i + 1} विफल, पुनः प्रयास कर रहा है...`, error);
}
}
}

function displayQuestion() {
explanationContainer.classList.add('hidden');
optionsContainer.innerHTML = '';

const currentQuestion = questions[currentQuestionIndex];
questionText.textContent = currentQuestion.question;
progressText.textContent = `${uiStrings[currentLanguage].questionProgress} ${currentQuestionIndex + 1} / ${questions.length}`;

const progressPercentage = ((currentQuestionIndex + 1) / questions.length) * 100;
progressBar.style.width = `${progressPercentage}%`;

const shuffledOptions = [...currentQuestion.options];
shuffleArray(shuffledOptions);

shuffledOptions.forEach(option => {
const button = document.createElement('button');
button.textContent = option;
button.classList.add('option-btn', 'w-full', 'p-3', 'md:p-4', 'rounded-lg', 'text-left', 'bg-white', 'bg-opacity-10', 'hover:bg-white', 'hover:bg-opacity-20', 'border-2', 'border-transparent', 'focus:outline-none', 'focus:border-indigo-500', 'transition-colors', 'text-base', 'btn-futuristic');
button.addEventListener('click', () => handleOptionClick(option, button));
optionsContainer.appendChild(button);
});

if (userAnswers[currentQuestionIndex] !== null) {
showAnswerResult(userAnswers[currentQuestionIndex]);
}
prevBtn.style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';
nextBtn.textContent = currentQuestionIndex === questions.length - 1 ? uiStrings[currentLanguage].finishBtn : uiStrings[currentLanguage].nextBtn;
}

function handleOptionClick(selectedOption, clickedButton) {
if (userAnswers[currentQuestionIndex] !== null) return;

userAnswers[currentQuestionIndex] = { selected: selectedOption };

if (selectedOption.trim() === questions[currentQuestionIndex].answer.trim()) {
score++;
scoreDisplay.textContent = `${uiStrings[currentLanguage].score}: ${score}`;
playSound(600, 'sine');
} else {
playSound(200, 'square');
}

showAnswerResult(userAnswers[currentQuestionIndex]);
}

function showAnswerResult(answerData) {
const correctAnswer = questions[currentQuestionIndex].answer;
const allOptionButtons = optionsContainer.querySelectorAll('.option-btn');

allOptionButtons.forEach(btn => {
btn.disabled = true;
const btnText = btn.textContent.trim();
if (btnText === correctAnswer.trim()) {
btn.classList.add('correct');
}
if (answerData.selected && btnText === answerData.selected.trim() && btnText !== correctAnswer.trim()) {
btn.classList.add('incorrect');
}
});

explanationText.textContent = questions[currentQuestionIndex].explanation;
explanationContainer.classList.remove('hidden');
}

function goToPreviousQuestion() {
if (currentQuestionIndex > 0) {
currentQuestionIndex--;
displayQuestion();
}
}

function goToNextQuestion() {
if (currentQuestionIndex < questions.length - 1) {
currentQuestionIndex++;
displayQuestion();
} else {
showResults();
}
}

function showResults() {
clearTotalTimer();
quizScreen.classList.add('hidden');
resultsScreen.classList.remove('hidden');
finalScoreText.innerHTML = `${uiStrings[currentLanguage].finalScore} <br> <span class="text-3xl md:text-4xl font-bold text-green-400 mt-2 inline-block">${score} / ${questions.length}</span>`;
finalTimeText.innerHTML = `${uiStrings[currentLanguage].finalTime} <br> <span class="text-2xl font-bold text-yellow-400 mt-2 inline-block">${elapsedTime}s</span>`;
}

function shareScore() {
const t = uiStrings[currentLanguage];
const shareText = t.shareMessage(
t.mainTitle,
score,
questions.length,
currentTopic,
gameLink
);

if (navigator.share) {
navigator.share({
title: t.mainTitle,
text: shareText,
url: gameLink
}).catch((error) => {
console.error('वेब शेयर एपीआई के साथ साझा करने में त्रुटि:', error);
const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
window.open(whatsappUrl, '_blank');
});
} else {
const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
window.open(whatsappUrl, '_blank');
}
}

function resetGame() {
clearTotalTimer();
langScreen.classList.remove('hidden');
startScreen.classList.add('hidden');
quizScreen.classList.add('hidden');
resultsScreen.classList.add('hidden');
loader.classList.add('hidden');
sideMenu.classList.remove('open');
sideMenu.classList.add('-translate-x-full');

topicInput.value = '';
questionsCountInput.value = '';
difficultyInput.value = 'easy';
questions = [];
userAnswers = [];
currentQuestionIndex = 0;
score = 0;
currentTopic = '';
elapsedTime = 0;
progressBar.style.width = '0%';
}

function getHistory() {
const historyKey = `quizTopicHistory_${currentLanguage}`;
const history = localStorage.getItem(historyKey);
return history ? JSON.parse(history) : [];
}

function loadTopicHistory() {
const history = getHistory();
topicHistoryList.innerHTML = '';
if (history.length === 0) {
historyContainer.classList.add('hidden');
return;
}

historyContainer.classList.remove('hidden');
history.forEach(topic => {
const li = document.createElement('li');
li.textContent = topic;
li.className = 'p-2 rounded-md text-gray-300 transition-colors hover:bg-white hover:bg-opacity-20 cursor-pointer';
li.addEventListener('click', () => {
topicInput.value = topic;
});
topicHistoryList.prepend(li);
});
}

function saveTopicHistory(topic) {
let history = getHistory();
history = history.filter(t => t.toLowerCase() !== topic.toLowerCase());
history.unshift(topic);
if (history.length > 10) history.pop();
const historyKey = `quizTopicHistory_${currentLanguage}`;
localStorage.setItem(historyKey, JSON.stringify(history));
loadTopicHistory();
}

function toggleMenu() {
sideMenu.classList.toggle('open');
sideMenu.classList.toggle('-translate-x-full');
}

function updateMenuContent(section) {
const t = uiStrings[currentLanguage];
menuContentText.dataset.activeSection = section;

const existingWhatsappButton = document.getElementById('whatsapp-channel-btn-menu');
if (existingWhatsappButton) {
existingWhatsappButton.remove();
}

if (section === 'description') {
menuContentTitle.textContent = t.descriptionTitle;
menuContentText.innerHTML = t.descriptionText;

let whatsappButtonInMenu = document.createElement('button');
whatsappButtonInMenu.id = 'whatsapp-channel-btn-menu';
whatsappButtonInMenu.textContent = t.whatsappChannelBtn;
whatsappButtonInMenu.classList.add('w-full', 'bg-emerald-500', 'hover:bg-emerald-600', 'text-white', 'font-bold', 'py-3', 'px-6', 'rounded-lg', 'text-lg', 'btn-futuristic', 'shadow-lg', 'mt-4');

whatsappButtonInMenu.addEventListener('click', () => {
window.open('https://whatsapp.com/channel/0029Vb6ZMmI3wtb6E8Jw3w28', '_blank');
});
menuContentText.appendChild(whatsappButtonInMenu);
} else if (section === 'help') {
menuContentTitle.textContent = t.helpTitle;
menuContentText.innerHTML = t.helpText;
} else if (section === 'home') {
menuContentTitle.textContent = '';
menuContentText.innerHTML = '';
}
}

langEnBtn.addEventListener('click', () => setLanguage('en'));
langHiBtn.addEventListener('click', () => setLanguage('hi'));
startBtn.addEventListener('click', startGame);
playAgainBtn.addEventListener('click', resetGame);
prevBtn.addEventListener('click', goToPreviousQuestion);
nextBtn.addEventListener('click', goToNextQuestion);
homeBtn.addEventListener('click', resetGame);
homeBtnResults.addEventListener('click', resetGame);
shareScoreBtn.addEventListener('click', shareScore);
whatsappChannelBtnResults.addEventListener('click', () => {
window.open('https://whatsapp.com/channel/0029Vb6ZMmI3wtb6E8Jw3w28', '_blank');
});

menuToggleBtn.addEventListener('click', toggleMenu);
closeMenuBtn.addEventListener('click', toggleMenu);
menuHomeBtn.addEventListener('click', () => {
toggleMenu();
resetGame();
});
menuDescriptionBtn.addEventListener('click', () => updateMenuContent('description'));
menuHelpBtn.addEventListener('click', () => updateMenuContent('help'));

window.addEventListener('resize', () => {
const appContainer = document.getElementById('app-container');
const gameWrapper = document.getElementById('game-wrapper');
const maxWidth = 450;
const aspectRatio = 9 / 16;
const currentWidth = Math.min(gameWrapper.clientWidth, maxWidth);
appContainer.style.width = `${currentWidth}px`;
appContainer.style.height = `${currentWidth / aspectRatio}px`;
});

window.dispatchEvent(new Event('resize'));
updateMenuContent('description');
updateUIText();
});
</script>
</body>
</html>
